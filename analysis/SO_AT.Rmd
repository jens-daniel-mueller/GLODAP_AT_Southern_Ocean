---
title: "Data base"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(scico)
```


```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```

# Subsetting criteria

```{r subsetting_criteria}

SO_lat_high <- -30
SO_lat_low <- -65

year_start  <- 2004
year_end    <- 2017
depth_lower_limit <- 500

f <- 2
qc <- 1

```

Southern Ocean is defined here as the area between:

- higher latitude: `r SO_lat_high`
- lower latitude:  `r SO_lat_low`

Time is restricted to years from:

- `r year_start` to `r year_end`.

Only observations with:

- maximum depth of `r depth_lower_limit`
- quality flag f: `r f`
- quality flag qc: `r qc`

were investigated. Quality flags were checked individually, only when `tco2` and `talk` observations are available.

```{r subset_GLODAP, eval=FALSE}

GLODAP <- read_csv(here::here("data/_summarized_data_files", "GLODAPv2.2019_Merged_Master_File_JM.csv"),
                   guess_max = 1e5)

# GLODAP_SO <- GLODAP_SO %>% 
#   mutate(decade = as.factor(decade))

GLODAP_SO <- GLODAP %>% 
  filter(latitude <= SO_lat_high, latitude >= SO_lat_low)

GLODAP_SO <- GLODAP_SO %>% 
  filter(year >= year_start, year <= year_end)

GLODAP_SO <- GLODAP_SO %>% 
  filter(tco2f == f,
         tco2qc == qc,
         !is.na(tco2))

GLODAP_SO <- GLODAP_SO %>% 
  filter(talkf == f,
         talkqc == qc,
         !is.na(talk))

GLODAP_SO <- GLODAP_SO %>% 
  filter(depth <= depth_lower_limit)

GLODAP_SO <- GLODAP_SO %>% 
  select(date, cruise:bottomdepth, depth:salinity, tco2, talk)

GLODAP_SO %>% write_csv(here::here("data/_summarized_data_files",
                                   "GLODAPv2.2019_Merged_Master_File_JM_SO.csv"))

```

```{r reopen_subsetted_GLODAP}

rm(depth_lower_limit, f, qc, SO_lat_high, SO_lat_low, year_end, year_start)

GLODAP_SO <- read_csv(here::here("data/_summarized_data_files", "GLODAPv2.2019_Merged_Master_File_JM_SO.csv"),
                   guess_max = 1e5)
```

# Gridding
## Vertical gridding

```{r depth_levels}

depth_levels <-
  c(2.5, 
    5, 
    seq(10,50,10), 
    seq(75,150,25), 
    seq(200,500,50), 
    seq(600,1900,100), 1975)

depth_intervals <-
  c(replace_na(depth_levels - (depth_levels - lag(depth_levels))/2, 0),
    2000)

```

As an adaptation of Lydia's interpolation to 33 depth levels:

`r depth_levels`

data were clustered into depth intervals between following depth levels:

`r depth_intervals`

This avoids creating "unobserved" values at the cost of vertical information.

```{r vertical_gridding}

GLODAP_SO <- GLODAP_SO %>% 
  mutate(depth_grid = as.numeric(as.character(cut(depth,
                          breaks = depth_intervals,
                          labels = depth_levels,
                          include.lowest = TRUE))))

# GLODAP_SO_depth_grid <- GLODAP_SO %>% 
#   select(date, year, month, latitude, longitude, tco2, talk, depth, depth_grid) %>% 
#   group_by(depth_grid, year, month) %>% 
#   summarise_all(lst(mean, sd, min, max), na.rm=TRUE) %>% 
#   ungroup()

```

## Horizontal

Observations were gridded to a 1 x 1 degree latitude and longitude grid.

For exploratory analysis, data were also clustered into coarse 20 degree longitude and 5 degree latitude grids.

```{r horizontal_gridding}

GLODAP_SO <- GLODAP_SO %>% 
  mutate(latitude_grid = as.numeric(as.character(cut(latitude,
                                                     breaks =  seq(-90, 90, 1),
                                                     labels = seq(-89.5,89.5,1)))),
         longitude_grid = as.numeric(as.character(cut(longitude,
                                                      breaks =  seq(-180, 180, 1),
                                                      labels = seq(-179.5,179.5,1)))),
         latitude_grid_coarse = cut(latitude, seq(-90,90,5)),
         longitude_grid_coarse = cut(longitude, seq(-180, 180, 40)))

```


## Surface map

```{r observations_map}

map_southpole <- borders("world", colour="gray60", fill="gray60", ylim = c(-90,-25)) # create a layer of borders

GLODAP_SO %>% 
  ggplot(aes(longitude, latitude, col=as.factor(year)))+
  map_southpole+
  geom_hline(yintercept = seq(-65, -30, 5))+
  geom_vline(xintercept = seq(-180, 180, 40))+
  geom_point()+
  coord_map("ortho", orientation = c(-90, 0, 0),
            ylim = c(-85,-30), xlim = c(-180,180))+
  scale_color_viridis_d(name="year")+
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())
  
```

```{r observations_map_year_grid}

GLODAP_SO %>% 
  ggplot(aes(longitude, latitude))+
  map_southpole+
  geom_hline(yintercept = seq(-65, -30, 5))+
  geom_vline(xintercept = seq(-180, 180, 40))+
  geom_point()+
  coord_map("ortho", orientation = c(-90, 0, 0),
            ylim = c(-85,-30), xlim = c(-180,180))+
  scale_color_viridis_d(name="year")+
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())+
  facet_wrap(~year, ncol = 3)
  
```


# Dissolved inorganic carbon (tco2)

## Time series

### Observed values

Observed variables for selected depth levels, colored by coarse latitute and longitude grids.

```{r tCO2_time_series_lon_grid}

GLODAP_SO %>% 
  filter(depth_grid %in% c(10, 100, 300, 500)) %>% 
  ggplot(aes(date, tco2, col=longitude_grid_coarse))+
  geom_vline(xintercept = ymd("2009-01-01"))+
  geom_point()+
  facet_wrap(~depth_grid)+
  theme(axis.title.x = element_blank())

```

```{r tCO2_time_series_lat_grid}

GLODAP_SO %>% 
  filter(depth_grid %in% c(10, 100, 300, 500)) %>% 
  ggplot(aes(date, tco2, col=latitude_grid_coarse))+
  geom_vline(xintercept = ymd("2009-01-01"))+
  geom_point()+
  scale_color_viridis_d()+
  facet_wrap(~depth_grid)+
  theme(axis.title.x = element_blank())

```

### Mean values

## Spatial distribution

```{r tco2_latitudinal_distribution}

GLODAP_SO %>% 
  filter(depth_grid %in% c(10, 100, 300, 500)) %>% 
  ggplot(aes(latitude, tco2, col=longitude_grid_coarse))+
  geom_point()+
  facet_wrap(~depth_grid)

```

```{r tco2_longitudinal_distribution}

GLODAP_SO %>% 
  filter(depth_grid %in% c(10, 100, 300, 500)) %>% 
  ggplot(aes(longitude, tco2, col=latitude_grid_coarse))+
  geom_point()+
  scale_color_viridis_d()+
  facet_wrap(~depth_grid)

```


```{r tco2_correlations}

GLODAP_SO %>% 
  filter(depth_grid %in% c(10, 100, 300, 500)) %>% 
  ggplot(aes(talk, tco2, col=latitude_grid_coarse))+
  geom_point()+
  scale_color_viridis_d(option = "magma")+
  facet_grid(.~depth_grid)

GLODAP_SO %>% 
  filter(depth_grid %in% c(10, 100, 300, 500)) %>% 
  ggplot(aes(latitude, tco2/talk, col=temperature))+
  geom_point()+
  scale_color_viridis_c(option = "magma")+
  facet_grid(.~depth_grid)


```


# Open tasks / questions

- found several rows with depth NA. What is that? So far excluded from analysis
- Check duplicated analysis at identical sampling location and time

Checks with Lydia

- number of tco2 observations in SO


